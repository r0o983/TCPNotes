# 第四章 网际层

## 基本概念  

网际层提供的协议负责局域网网段之外的传递，其中重要的协议包括IP，ARP和ICMP  

## 4.1 寻址与发送  

计算机通过网络接口设备（比如网络适配器）与网络进行通信，网络接口设备具有唯一的物理地址，用于接收发向该地址的数据，像以太网网卡这样的设备对于上层协议层的细节是一点也不了解的，它不知道IP地址，也不知道发送来的帧是要给Telnet还是FTP，它只是监听是否收到了数据帧，发现其中目标地址与自己物理地址相符的帧，并把这个帧传递给上层协议栈  

这种物理寻址方式适合单个局域网望断，由不间断介质连接在一起的若干台计算机利用物理地址就可以实现所需的功能。只需使用网络访问层的低级协议就可以把数据从网络适配器直接传递到另一个网络适配器  

但是在路由式网络中，不能利用物理地址实现数据传输，因为根据物理地址进行所需的过程不能跨越路由接口来运行，即使这样式可行的，根据物理地址传输数据也是非常麻烦，因为内置在网卡里的固定物理地址不能在地址空间上引入逻辑结构  

因此，TCP/IP隐藏了物理地址，以一种逻辑化，层次化的寻址方案对网络进行组织。这种逻辑寻址方案由网际层的IP协议维护，而逻辑地址被称为IP地址，地址解析协议（ARP）是另一种网际层协议，它维护一个表格，用于把IP地址映射到物理地址。这个ARP表连接了IP地址与网卡物理地址  

网关接收去往其他网络的数据报时，会发生以下一些操作  

1.如果目的地址与源地址在同一个网段，源计算机就把数据包直接发送给目的计算机。IP地址被ARP解析为物理地址，数据被直接发送到目的网络适配器  

2.如果目的地址与源地址不在一个网段上，就执行如下过程  

* 直接将数据报发给网关，网关是位于局域网网段上的一个设备，能够把数据报转发到其他望断（在第一章讲到，网关基本上也算是一个路由器）。网关地址呗AR片解析为物理地址，数据呗发送到网关的网络适配器  
* 数据报通过网关被路由到较高级别的网段，在此重复上述过程。如果目的地址在这个新网段内，数据就被发送到目的地，否则数据报就会被发送到另一个网关  
* 数据报经过一系列网关呗转发到目的望断，目的IP地址被ARP解析为物理地址，数据被发送到目的网络适配器  

为了在复杂的路由式网络中传输数据，网际层协议必须具有以下功能：  

* 识别网络中所有的计算机  
* 提供一种方式来判断何时需要通过网关来传递消息  
* 提供一种与硬件无关的方式来识别目的网段，从而让数据报能够高效率地经过路由器到达正确的网段  
* 提供一种方式把目标计算机的逻辑IP地址转化为物理地址，让数据能够传输给目的计算机的网络适配器  

**注意：** 网际层和OSI  

网际层对应于OSI模型的网络层，也就是所谓的第三层  

## 4.2 网际协议（IP）

IP协议提供了一种分层的，与硬件无关的寻址系统，具有在复杂的路由式网络中传递数据所需的服务，TCP/IP网络上的每个网络适配器都有一个唯一的IP地址  

**注意：**  主机

在讨论TCP/IP时，我们经常会说计算机有一个IP地址，这是因为大多数计算机只有一块网卡，然而具有多个网卡的计算机也很常见，比如作为路由器或代理服务器的计算机必须有多个网卡，因此也就有多个IP地址，术语“主机”通常用于表示与某个IP地址相关联的网络设备  

在某些操作系统上可以给一个网络适配器指定多个IP地址  

网络上的IP地址是有一定规则的，因此我们可以通过查看IP地址来了解主机的位置，也就是它所在的网络或子网，换句话说，IP地址中有一部分有点像邮政编码（表明大致区域），而另一部分有点像街道地址（表明大致区域内的准确位置）  

IP地址分为两个部分：

* 网络ID  

* 主机ID  

网络必须提供一种方式来判断IP地址的那一部分是网络ID，哪一部分是主机ID，但是真实世界中网络的多样性和复杂性使得我们无法使用一个简答，通用的方法解决这个问题  

该问题最初的绝对方案是把IP地址划分为一系列地址类，A类地址使用地址前8位作为网络ID，B类地址使用前16位，C类地址使用地址前24位。后来这个方案增加了一个名为“子网划分”的特性，用于在本地范围对网络结构实现更好的控制  

最近新出现的无类别域间路由选择（CIDR）技术让上述地址分类系统基本上变得毫无意义，它目前在Internet上非常流行，为IP地址提供了一种简单，灵活和明确的表示  

如果想了解TCP/IP网络，掌握基于分类的寻址系统和CIDR寻址都是很重要的，只需要记住这些标示方案的目标是一致的：把IP地址区分为网络ID和主机ID  

**注意：** 子网划分

### 4.2.1 IP报头字段

每个IP数据报都以一个IP报头开始，源计算机的TCP/IP软件构造这个IP报头，目的计算机的TCP/IP软件利用IP报头重封装的信息处理数据。IP报头包含大量信息，包括源IP地址，目的IP地址，数据报长度，IP版本号和对路由器的特殊指令  

**注意：** 报头的更多细节  

有关IP报头的更多细节，请参见RFC 791  

IP报头的最小长度是20字节  

* 版本：这个4位的字段表示所使用的IP版本，目前IP版本是4，相应的二进制是0100  

![image-20200501153238153](../assets/image-20200501153238153.png)

* 网际报头长度（IHL）：这个4位字段表示IP报头以32位字为单位的长度。IP报头的最小长度是5个32比特字，相应的二进制表示是0101  
* 服务类型：源IP能够制定特殊的路由信息。有些路由器会忽略这个字段的信息，但随着服务质量（QoS）技术的出现，这个字段得到了更多的重视。这个8位字段的主要用途是对等待通过路由器的数据报区分优先级，而目前大多数IP实现是把这个字段全填为0  
* 总长度：这个16位的字段表示IP数据报的长度，单位是字节，这个长度包含了IP报头和数据载荷  
* 标识：这个16位的字段是一个依序变大的数值，分配给源IP发出的消息，当传递到IP层的消息太大而不能放到一个数据报里时，IP会把消息拆分到多个数据报，并对这些数据报排序分配相同的标示号。接收端利用这些数值重组为原始消息  
* 标记：这个字段表示分段可能行。第一位未使用，其值应该为0，第二位称为DF（不分段），表示是否允许分段，0表示允许，1表示不允许。第三位是MF（更多分段），表示是否还有分段正在传输，设置为0时表示没有更多分段需要发送，或是数据报根本没有分段  
* 分段位移：这个13的字段是一个数值，被赋予每个连续的分段，目的设备的IP利用这个值以正确的次序重组分段，这个数值使用的单位是8字节  
* 生存时间（TTL）：这个字段表示数据报在被抛弃之前能够保留的时间（以秒为单位）或路由器跳数，每个路由器都会检查这个字段，并且至少把它减去1，或数据报在路由器中延迟的秒数，当这个字段的值为0时，数据报会被抛弃  
* 跳数代表数据报到达目的之前必须经过的路由器的数量，如果数据报在到达目的之前经过了5个路由器，我们就说距离目的有5跳。  
* 协议：这个8位的字段表示接收数据载荷的协议，比如协议标识为6（二进制为00000110）的数据报会被传递到TCP模块，常见协议表示值见下图  

![image-20200501165958601](../assets/image-20200501165958601.png)

* 报头校验和：这个字段包含16位的校验和，只用于检验报头本身的有效性。数据报经过的每个路由器都会对这个值进行重新计算，因为TTL字段的值是在不断变化的  
* 源IP地址：这个32位的字段包含了数据报的源IP地址  
* 目的IP地址：这个32的字段包含了数据报的目的IP地址，目的IP地址这个值检验发送的正确性  
* IP选项：这个字段支持一些可选的报头设置，主要用于测试、调试和安全的目的。这些选项包括严格源路由（数据报必须经过指定的路由）、国际时间戳（经过每个路由器时的时间戳记录）和安全限制  
* 填充：IP选项字段的长度不是固定的，填充字段可以提供一些额外的0，从而保证整个报头的长度是32位的整倍数（报头长度必须是32位字的整倍数，因为“网际头长度（IHL）”字段以32位字为单位表示报头的长度）  
* IP数据载荷：这个字段一版用于保存传递给TCP和UDP（在传输层中）、ICMP或IGMP的数据。数据块的长度不定，可以包含数千字节  

### 4.22 IP寻址  

IP地址是一个32位的地址，被分为4个8位段（八位组）IP地址最常用的表达形式是“点分十进制形式”每个八位组都以相应的十进制数值表示，4个十进制数值以句点分割，8位二进制可以表示0-255之间的数值，所以这种形式中每个十进制的数值都位于0-255之间，点分十进制的IP地址表示为：209.121.131.14  

IP地址中的一部分是网络ID，另一部分是主机ID，划分网络ID和主机ID的最初方案是使用地址分类，虽然最近出现的CIDR无类别寻址降低了地址分类的重要性，但作为理解TCP/IP寻址的一个出发点，地址分类还是值得在此进行讨论的  

地址分类系统把IP地址划分到不同的地址类，绝大多数的IP地址属于以下几类：  

* A类地址：IP地址的前8位表示网络ID，后24位表示主机ID  
* B类地址：IP地址的前16位表示网络ID，后16位表示主机ID  
* C类地址：IP地址的前24位表示网络ID，后8位表示主机ID  

A类地址提供了较少的网络ID，但每个网络都具有大量可用的主机ID，一个A类网络大约可以包含224，也就是16777214台主机，与之相对的是，C类地址只能包含较少的主机（254台，也就是28，或256减去不可用的全0地址和全1地址）但网络ID的组合就非常多了  

如何判断一个IP地址是A类、B类或是C类呢？TCP/IP地址规则使得地址本身就可以说明其类别：二进制地址的前几个位说明了地址属于哪一类，规则如下  

* 如果32位的地址以0开头，它就是A类地址  
* 如果32位的地址以10开头，它就是B类地址  
* 如果32位的地址以110开头，它就是C类地址  

![image-20200501174750586](../assets/image-20200501174750586.png)

这种规则很容易转化为点分十进制形式，因为它们有效地限制了地址中第一个值的范围，例如，由于A类地址中第一个值最高不能大于127  

**注意：** D类和E类地址  

Internet规范还定义了特殊用途的D类和E类地址，D类地址用于多播，多播是把一个消息发送到网络的子网，这与广播是不同的，后者需要网络上全部节点都进行处理。D类地址最前面的四位是1110，对应于十进制数值是224-239。E类网络是实验性质的，一般不用于生产环境，E类网络地址最前面的5位是11110，对应于十进制数值是240-247  

网络管理员可以把网络划分为更小的次级网络，这被称为子网。划分子网的性质就是借用主机ID中的一些位，在网络内创建额外的网络，根据前面的分类介绍，我们很容易会想到具有大量主机ID的A类和B类地址会广泛使用子网划分技术，当然，C类网络也会使用子网划分技术  

**注意：地址是否唯一** 

从理论上讲，Internet上每台计算机都必须有一个唯一的IP地址，在实际应用中，代理服务器软件和NAT设备的使用让未注册和非唯一的地址也可以连接Internet  

### 4.2.3 将32位的二进制地址转换为点分十进制形式  

二进制数字（基数是2）类似于十进制数字（基数是10），只是每一位代表的值是2的乘方而不是10的乘方，十进制数字从最右边代表1的位置开始，每向左移一位所代表的值就乘以10，整个数字的值就是每一位上的值之和，十进制数字126325的值是这样得出的：（1x100100）+（2x10000）+（6x1000）+（3x100）+（2x10）+（5x1）= 126325  

![image-20200501185453571](../assets/image-20200501185453571.png)

二进制数字最右边的位置也代表1，每向左移一位所代表的值就乘以2  

![image-20200501185605552](../assets/image-20200501185605552.png)

**注意：** 0和1

计算机以二进制形式工作，因为0和1正好与数字电路板的开和关状态相对应

只要把二进制数值中为1的位置所代表的数值相加起来，就可以得到相应的十进制数值。IP地址是由4个8位组组成的，每个八位组必须单独进行转换，下面的例子展示了如何把32位的二进制IP地址转化为点分十进制形式  

转化二进制地址01011001000111011100110000011000的步骤如下  

1.把地址划分为8位的八位组  

八位组1:01011001  

八位组2:00011101  

八位组3:11001100  

八位组4:00011000  

2.把每一个八位组转化为十进制数值，其过程如下图所示  

![image-20200501190248426](../assets/image-20200501190248426.png)

3.按照从左到右的次序写下十进制值，用句点分割每个值，地址就是：89.29.204.24  

### 4.2.4 十进制转换为二进制八位组  

把十进制转化为二进制八位组的步骤如下所示  

1.把要转换的值（本示例为207）与128相比，如果大于128就把它减去128，并写下1，如果小于128就减去0，并写下0  

207>128  

207-128=79  

值128对应的位写下1  

到目前为止的结果是：1  

2.采用第一步里得到的结果79，把它与64相比，如果大于等于64，就减去64，并写下1，如果小于64就减去0，并写下0  

79>64  

79-64=15  

值对应的位写下1  

到目前为止的结果是：11  

3.采用第二步里得到的结果15，把它与32相比，如果大于等于32，就减去32，并写下1，如果小于32，就减去0，并写下0  

15<32  

15-0=15  

值32对应的位写下0  

到目前为止的结果是：110

4.采用第三步里得到的结果15，把它与16相比，如果大于等于16，就减去16，并写入1，如果小于16，就减去0，并写下0  

15<16  

15-0=15  

值16对应的位写下0  

到目前为止的结果是：1100  

5.采用第四步得到的结果与8相比，如果大于8，就减去8，并写下1，如果小于8，就减去0，并写下0  

15>8  

15-8=7

值8对应的位写下1  

到目前为止的结果是：11001  

6.将第五步的结果与4相比，如果大于4则减去4，并写下1，如果小于4，就减去0，并写下0  

7>4  

7-4=3  

值4对应的位写下1  

到目前为止的结果是：110011  

7.将第六步的结果与2相比，如果大于2等于2，就减去2，并写下1，如果小于2，就减去0，并写下0  

3>2  

3-2=1  

值2对应的位写下1  

到目前为止的结果是：1100111  

8.如果第七步得到的结果是1，就写下1，如果第七步得到的结果是0，就写下0  

1 = 1  

值1对应的位写下1  

最后的结果是：11001111  

这样就把十进制数值207转化为相应的二进制11001111  

**注意：** 十进制转二进制可以直接将当前数字除以2，直到最后结果为1为止

207/2=103余数为1  

103/2=51余数为1  

51/2=25余数为1  

25/2=12余数为1  

12/2=6余数为0  

6/2=3余数为0  

3/2=1余数为1  

1最终数字为1  

将所有数字从下向上进行排序即可！得到的结果为：11001111  

### 4.2.5 特殊的IP地址  

有一些特殊的IP地址具有特殊含义，不会分配给主机，全0的主机ID表示网络自身，例如：IP地址129.152.0.0是值网络ID为129.152的B类网络  

全1的主机ID表示广播，广播是向网络中全部主机发送的消息，IP地址129.152.255.255就是网络ID为129.152的B类网络的广播地址（十进制的255对应全1的八位组11111111）  

地址255.255.255.255也可以用于网络上的广播  

以十进制127开头的地址是环回地址，目的地址为环回地址的消息是由本地TCP/IP软件发送的，其目的在与测试TCP/IP软件是否工作正常  

RFC1597（之后被RFC1918取代）保留了一些IP地址范围用于私有网络，其设想是这些私有网络不会连接到Internet，所以不必要求是唯一的，目前这些私有地址范围经常用于“网络地址转换（NAT）”设备背后的受保护网络  

* 10.0.0.0 ～ 10.255.255.255  
* 172.16.0.0 ～ 172.31.255.255  
* 192.168.0.0 ～ 192.168.255.255  

由于私有地址范围不必与其余地址同步，所以整个地址范围对于任何网络都是可用的，网络管理员利用这些私有地址可以获得更大的子网空间和可用地址范围  

地址范围169.254.0.0 ～ 169.255.255.255 保留用于自动配置  

## 4.3 地址解析协议（ARP）  

局域网上的计算机使用网际层的地址解析协议（ARP）把IP地址映射为物理地址，主机必须知道目的网络适配器的物理地址才能向它发送数据，由此可见，ARP是一个重要的协议，但是TCP/IP的实现方式让ARP和关于物理地址转换的任何细节对于用户来说几乎是完全透明的，对于用于来说，网络适配器就是以IP地址标识的，然而在幕后，IP地址必须映射到物理地址，消息才能达到目的地  

网段上每台主机在内存中都保存着一个被称为ARP表或ARP缓存的表格，其中包含网络上其他主机的IP地址或物理地址的对应关系，当主机需要向网段上的其他主机发送数据时，它会查看ARP缓存来获得目的的物理地址，ARP缓存是动态变化的，如果要接收数据的当前地址并不存在与ARP缓存，主机就会发送一个名为ARP请求帧的广播  

ARP请求帧包含未解析的IP地址，还包含发送这个请求的主机和IP地址和物理地址。网段上的其他主机接收到这个ARP请求，拥有这个未解析IP地址的主机会向发出请求的主机发送自己的物理地址，这个新的IP地址与物理地址的对应关系就会添加到请求主机的ARP缓存里，一般来说，ARP缓存里的条目在一定时间之后会过期，条目就会被从表里删除，当主机需要向这个条目所包含的IP地址发送数据时，解析过程会再次重复  

## 4.4 逆向ARP（RARP）

RARP的含义是逆向ARP，也就是ARP的逆过程，当我们知道IP地址而步知道物理地址时，可以使用ARP，而在知道物理地址而步知道IP地址时，则应该使用RARP。RARP经常用BOOTP协议共同使用来启动无盘工作站  

**注意：** BOOTP（启动PROM）

很多网络适配器具有一个空的插槽，支持被称为‘启动RPOM’的集成电路，计算机一加电，PROM固件就会启动，从网络服务器而不是本地硬盘来读取并加载操作系统，下载到BOOTP设备的操作系统被预配置为特定的IP地址  

## 4.5 Internet控制消息协议（ICMP）

发送到远程计算机的数据通常会经过一个或多个路由器，这些路由器把数据传输到最终目的地的过程中可能会发生多种问题，路由器利用Internet控制消息协议（ICMP）消息把问题通知给源IP，ICMP还有用于其他调试和排错功能  

下面列出最常见的ICMP消息，当然还有其他的一些情况会产生ICMP消息，但是它们发生的概率是相当低的  

* Echo Request（回显请求）和Echo Reply（回显应答）：ICMP经常被用于测试，比如测试连接的ping命令实际上就是在使用ICMP，ping向某个IP地址发送一个数据报，并且要求目的计算机在相应中返回所发送的数据。ping实际使用的命令是ICMP的Echo Request 和Echo Reply  
* Source Quench（源抑制）：如果一台高速计算机向远程计算机发送大量数据，可能会使路由器过载，这时路由器可以利用ICMP向远IP发送Source Quench消息，让它降低发送数据的速度，如有必要，还可以向源IP发送额外的源抑制消息  
* Destination Unreachable（目的不可达到）：如果路由器收到一个不能传递的数据报，ICMP就会想源IP返回一个Dest nation Unreachable消息，路由器不能传递消息的原因之一是网络由于设备故障或维修而关闭  
* Time Exceeded（超时）：当数据报由于TTL为0而被抛弃时，ICMP就会像源IP发送这个消息，这表示对与当前TTL值来说，到达目标需要经过太多的路由器，或者是路由表出了问题，导致数据报在同一台路由器上连续循环  
* 当数据报无限循环且永远不能达到目的地时，就会发生路由环路，当管理员在路由表里设置了一条静态路由时，有时就可能会导致环路路由  
* Fragmentation Needed（需要分段）：如果一个数据报的“dont fragment（不可分解）”位被设置为1，而路由器必须要对数据报进行分段才能把它转发到下一台路由器或目的地时，这时ICMP就会发送这条消息  

## 4.6 网际层其他协议

网际层还包含一些其他协议，比如用于路由进程的边界网关协议（BGP）和路由信息协议（RIP）  

IPSec协议在IPv4里面是可选的，但在IPv6里面就是必须的，它也工作在网际层，提供一个安全的加密通信，其他一些网际协议还包括用于多播的协议，网际层对应OSI模型的第三层，所以一切都被称为第三层协议的协议都工作于网际层  

## 4.7 小结

本章介绍了网际层协议IP、ARP、RARP和ICMP。IP提供了一种与硬件无关的寻址系统，用于在网络上传输数据，我们学习了二进制和点分十进制IP地址格式，以及IP地址的A、B、C、D、和E类地址，ARP是把IP地址解析为物理地址的协议，RARP是ARP的逆向过程，可以让无盘计算机向服务器进行查询来获得自己的IP地址，ICMP是用来诊断和测试的协议  

## 4.8 问与答

问：常用什么地址标记方式来简化32位二进制地址？  

**答：** 点分十进制  

问：在收到一个IP地址时，ARP会返回什么信息？  

**答：** 相应的物理地址（MAC）地址  

问：如果路由器来不及处理大量流量，源IP会收到什么类型的ICMP消息？  

**答：** Source Quench（源抑制）消息  

问：以110开头的二进制地址术语哪一类IP地址？  

**答：** C类地址  

## 4.9 测验

### 4.9.1 问题

1.IP报头中的TTL字段的用途是什么？  

**答：** 记录当前经过了多少路由器或主机，每经过一台设备，TTL值会减1，当TTL值为0时，数据会被抛弃，主要用于防止数据不断环回  

2.A类地址中的网络ID和主机ID的范围分别是多大？  

**答：** 网络ID是8位，主机ID是24位  

3.什么是八位组？  

**答：** 八位组是一个8位的数据片，现在通常将其称为字节  

4.IP地址是什么地址？  

**答：** IP地址是计算机或网络设备的一个独立网络接口地址  

5.ARP和RARP之间的区别是什么？  

**答：** ARP使用IP地址来获取用户的MAC地址，RAPP则使用MAC地址获取用户当前的IP地址  

## 4.10 练习

略  

## 4.11 关键术语

复习下列关键术语：  

* 地址类：IP地址的分类系统，网络类别确定了将地址划分为网络ID和主机ID的方式  
* 地址解析协议（ARP）：网际层的重要协议，用于获取与IP地址相对应的物理地址，ARP缓存记录着最近解析的物理地址和IP地址对  
* BOOTP：用来远程启动计算机或其他网络设备的协议  
* 点分十进制：基数为10，而且使用4个数字来表示二进制IP地址的形式，这4个数字分别表示二进制地址的4个八位组，这4个数字之间使用句点分开  
* 主机ID：IP地址的组成部分，代表网络上的一个节点，一个网络内每个节点的IP地址都应该具有唯一的主机ID  
* Internet控制消息协议（ICMP）：网际层的重要协议，路由器利用它发送消息来告知源IP关于路由器的问题，ping命令也使用ICMP来判断网络上其他主机的状态  
* 网际协议（IP）：网际层的重要协议，用于数据报的寻址，传递和路由  
* 多播：允许数据报同时发送给一组主机的技术  
* 网络ID：IP地址的组成部分，表示网络  
* 八位组：一个8位的二进制数值  
* 逆向地址解析协议：TCP/IP的一个协议，根据物理地址返回相应的IP地址，一般被远程启动的无盘工作站使用  
* 子网：TCP/IP地址空间的逻辑划分  