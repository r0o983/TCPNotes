# 第二十一章 电子邮件

## 21.1 什么是电子邮件

略

## 21.2 电子邮件格式

在Internet上发送的电子邮件消息由两个部分组成：报头和主体

类似消息的主体，报头也基于ASCII的文本形式传输，这种报头包括一连串关键字字段，后面跟着一个或多个逗号分开的值，其中一些重要的报头字段如下表所示：

**一些重要的电子邮件报头字段** 

![image-20200517092927820](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517092927820.png)

在报头之后，是一个空白行，而紧跟着那个空白行的就是消息的主体（电子信件的实际文本）

早期的策略包括将二进制位转换为某种ASCII对等物，最后所得到的文件看起来像是ASCII文本，实际上，它就是ASCII文本，但是你无法读懂它，因为它只是一堆代表原始二进制码的杂乱的字母

对于通过电子邮件发送的二进制文件，一种更加普遍而通用的解决方案是已经通过MIME格式显现出来，MIME是一种用来拓展Internet电子邮件能力的通用格式，启用了MIME的电子邮件应用程序，会在传输之前，把二进制附件编码成MIME格式，当收件人下载电子邮件消息时，其计算机上启动了MIME的电子邮件应用程序将解码响应的附件，并将其恢复至最初形式

MIME为Internet邮件带来了如下一些创新：

* 扩展了字符集，MIME并不局限于标准的128位ASCII字符集，这意味着你可以使用它传输特殊字符以及在美国英语中不存在的字符
* 无限制的文本行长度和消息长度
* 针对附件的标准编码技术
* 可以将图像，声音，连接和格式化文本集成到邮件消息中

绝大多数的电子邮件客户端应用程序都支持MIME

## 21.3 电子邮件的工作方式

与其他Internet服务相似，电子邮件也是围绕客户端/服务器的过程构建的，不过，电子邮件过程要稍微复杂一些，概括的说，电子邮件事物两端的计算机均充当客户端，而邮件消息则通过这两者之间的服务器来在网络上传递

一个客户端向某个电子邮件服务器发送一则消息，该服务器读取预期收件人的地址，并将邮件消息转发给与目的地址相关联的另一台电子邮件服务器，邮件消息被存储在那台目的地电子邮件服务器的某个邮箱中，该消息地址所指向的用户时不时的登录这台电子邮件服务器查看邮件消息

在过去，标准的过程要求用户计算机上有一个客户端程序来下载此用户邮箱中等待的消息，随后，用户才能阅读，存储，删除，转发或者答复响应的电子邮件消息，尽管这种方法很普通，但是比较新的技术（比如IMAP和Webmail）允许用户在服务器上管理其邮件，而不必下载它们

电子邮件地址为服务器提供转发邮件消息所需的寻址信息，一直越来越流行的Internet电子邮件地址格式如下：

用户@服务器 zhangsan@lisi.com wangwu@163.com

**电子邮件交付过程** 

![image-20200517094832698](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517094832698.png)

在这种标准的格式中，@符号之后的文本就是目的地电子邮件服务器的名称，而@符号之前的文本，则是手贱人在该电子邮件服务器上的邮箱名称

**注意：电子邮件和DNS** 

@符号之后的文本通常表示收件人域上默认电子邮件服务器的域名，响应域的DNS服务器持有一个MX资源记录，后者将一个邮件服务器与此域名相关联

电子邮件地址的格式，强调有关Internet电子邮件的一个重要观测结论：电子邮件消息的目的地并不是收件人的计算机，而是收件人在电子邮件服务器上的邮件，从电子邮件服务器上将等待着电子邮件消息传输到收件人计算机，这最后一步实际上是一个单独的过程，这一步是通过某种检索协议来管理的，比如说邮局协议（Post Office Protocol，POP）或者Internet消息访问协议（Internet Message Access Protocol，IMOP）

为了提高传递效率，有些网络使用分级的电子邮件服务器体系，在这种情况下，有一台本地电子邮件服务器向中继电子邮件服务器转发消息，中继电子邮件服务器接着把相应的邮件发送给目的地网络上的另一台中继服务器，然后，这台中继服务器再把邮件消息发送给与收件人相关联的本地服务器

**中继服务器通常可以增加邮件传递过程的效率** 

![image-20200517095434915](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517095434915.png)

## 21.4 简单邮件传输协议（SMTP）

SMTP是电子邮件服务器用来在TCP/IP网络上转发消息的协议，发起某一电子邮件消息的客户端计算机，也使用SMTP向某台本地服务器发送该消息以进行传输

与其他的TCP/IP应用服务相似，SMTP也通过TCP/IP协议栈与网络进行通信，电子邮件应用程序的职责很简单，因为该应用程序可以依靠TCP/IP协议软件的连接和验证服务器，默认情况下，SMTP通信通过到SMTP服务器端口25的一个TCP连接进行，客户端与服务器之间的对话，由客户端发出的四字符标准命令（和数据）以及不时的从服务器发出的三位响应代码组成

**SMTP客户端命令** 

![image-20200517095843665](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517095843665.png)

**部分SMTP服务器相应代码** 

![image-20200517095903141](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517095903141.png)

向电子邮件服务器发送一则消息的过程大致如下：

1. 发送端计算机向相应的服务器发出一个HELO命令，发送者的域名作为一个参数包含在其中
2. 服务器发挥响应代码250
3. 发送方发出MAILFROM：命令，发送消息的用户的电子邮件地址作为一个参数包含在其中
4. 服务器发回响应代码250
5. 发送方发出RCPT TO：命令，消息收件人的电子邮件地址作为一个参数包含在其中
6. 如果相应的服务器可以为此收件人接收邮件，那么该服务器发送回响应代码250，否则，该服务器将发送回一个表示问题的代码（比如550）
7. 发送方发出DATA命令，表示它准备开始发送电子邮件消息的内容
8. 服务器发出响应代码354，指示发送方开始传输消息内容
9. 发送方发送消息数据，并且在一行上以一个句点结束（.）
10. 服务器发送回响应代码250，表示邮件已被接受
11. 发送方发出QUIT命令，表示传输完成，当前会话应该被关闭
12. 服务器发送代码221，表示传输通道将被关闭

网络采用这个SMTP通信过程，将电子邮件消息传递给目的地电子邮件服务器上的用户邮箱，该消息然后一直在用户邮箱中等待着，直到用户登录进来查看响应的邮件，根据所用协议或电子邮件客户端类型的不同，要么该消息呗下载到用户计算机进行查看和处理，要么用户直接在响应的服务器上编辑和管理该消息

## 21.5 检索邮件

上一节所描述的SMTP交付过程，其目的并不是向某用户交付邮件，而仅仅是向该用户的邮箱交付邮件，用户接下来必须访问该邮箱，才能查看相应的邮件，这个额外的步骤可能会使上述过程复杂化，但是它具有以下优点：

* 服务器将继续为用户接受邮件，即时当用户的计算机并没有连接到网络的时候
* 电子邮件交付系统不受收件人的计算机或位置影响

**注意：** 电子邮件和网络安全

实际上，网络安全结构（比如防火墙）有时会阻止用户从陌生位置查看和发送电子邮件

保留用户邮箱的电子邮件服务器，通常必须同时支持SMTP服务（用于接收传入的消息）和一种邮件检索协议服务（用于允许用户访问相应的邮箱）这一交互需要SMTP服务和邮件检索服务之间的协调与兼容，这样数据才不会在两个服务同时访问相同的邮箱时发生丢失或者破坏

**SMTP服务应用程序和邮件检索服务应用程序必须协调对邮箱的访问** 

![image-20200517102758633](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517102758633.png)

### 21.5.1 POP3

默认情况下，POP3服务器在TCP端口110上倾听连接请求，在相应的连接被建立之后，客户端应用程序必须向电子邮件服务器发送用户名和密码信息，如果登录凭证被接受，那么用户就可以访问相应的邮箱来下载或删除消息了

与SMTP客户端相似，POP3客户端使用一连串四字符命令与服务器进行通信，服务器使用少量字母应答与相应，比如+OK（表示当前命令已经被执行）和-ERR（表示当前命令导致一个错误），这些响应还可能包括额外的参数，邮箱中的每一则消息均由一个消息编号来索引，客户端向服务器发送一条REST（检索）命令来下载一则消息，DELE命令将从服务器上删除一条消息

POP3客户端和服务器之间发送的消息，对于用户来说是不可见的，这些命令作为对用户在电子邮件客户端用户界面内的活动的响应，由电子邮件客户端应用端应用程序发出

POP3的一个缺点是，只能在服务器上实现有限的功能，用户只能在邮箱里列出响应的消息，删除消息和下载消息，对消息内容的任何操作都必须在客户端进行，这一限制会从服务器向客户端下载消息时，造成延迟和增加网络流量，于是，更新，更强大的IMAP协议被开发出来，以弥补其中的一些不足之处

### 21.5.2 IMAP4

Internet消息访问协议版本4（IMAP4）是一种与POP3相似的消息检索协议，不过，IMAP4提供了接种POP3所不具有的新特性，有了IMAP4，你可以浏览基于服务器的文件夹，以及不必首先把消息复制到本地的计算机上，就可以移动，删除和查看那些消息，IMAP4还允许你保存特定的位置，比如客户端窗口外观或者是服务器上针对指定搜索字符串的搜索消息，你还可以创建，删除，和重新命名服务器计算机上的邮箱

绝大多数最近的电子邮件客户端都同时支持POP3和IMAP4，尽管目前POP3的用户基础要更广一些，但是IMAP的许多优点确保电子邮件安装将继续不断得向IMAP4协议转换

## 21.6 电子邮件客户端

电子邮件客户端提供以下3个功能：

* 使用SMTP，向一台外发电子邮件服务器发送出站消息
* 使用POP3或IMAP，从一台电子邮件服务器收集传入的电子邮件消息
* 充当阅读，管理和撰写邮件消息的用户界面

电子邮件客户端必须能够同时充当SMTP客户端和邮件检索（POP或IMAP）客户端

同时你还需要知道以下信息：

* 电子邮件服务器的完全限定域名，以用来向外发送邮件，这个服务器通常接受主机名SMTP，后面跟着相应的域名（例如：SMTP.rosbud.org）
* POP或者IMAP服务器完整的完全限定主机名
* POP或者IMAP服务器上一个电子邮件用户账户的用户名和密码

配置一个电子邮件客户端的任务，很大程度上就是获得这些参数并把它们输入该电子邮件客户端程序而已

**随着电子邮件的兴起，一种蠕虫病毒随之诞生** 

![image-20200517142534545](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517142534545.png)

## 21.7 webmail

优点：通用，易于使用

缺点：安全性较差，性能较低，比较依赖网络环境

## 21.8 垃圾邮件

**垃圾邮件制造者们有时可以利用其他人未经保护和没有疑心的电子服务器发送其消息** 

![image-20200517143044894](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517143044894.png)

通过把邮件服务器放置在公司防火器内侧，并在防火墙处阻止发来的 SMTP 请求，公司即可保护自己不会成为垃圾邮件中继站，如图所示，来自防火器内侧的邮件客户端，可以使用相应的邮件服务器转发消息，但是位于外侧的客户端却无法到达该邮件服务器，这一技术对于控制垃圾邮件来说十分有用，不过，它也会造成一些局限性，对于一名来自这种本地网络的用户，在他带着笔记本电脑旅行或从某个外部位置检查邮件时，就可能会发现，如果不重新配置电子邮件客户端以指向另一台 SMTP 服务器，便将无法发送消息，一种逐渐流行起来而且更为灵活的解决方案是，让SMTP服务器位于防火墙外侧，但是需要通过电子邮件客户端来进行身份验证，当代大多数电子邮件客户端应用程序都支持这种验证设置，以用于向外发送邮件

**在防火墙之后设置SMTP服务器以及阻止发来SMTP请求，以保护服务器免遭垃圾邮件制造者的滥用** 

![image-20200517143610394](https://raw.githubusercontent.com/christopher-x/images/main/image-20200517143610394.png)

另一种防御手段被称为灰名单，灰名单系统临时拒绝来自某一未知源的消息，如果相应的消息是合法的，那么发送服务器会再次传输该消息，然而，垃圾邮件服务器通常都是自动化的工具，它们没有被设计成在交付失败时再次进行传输，如果服务器没有再次发送，那么相应的消息就被假定为垃圾邮件，等到垃圾邮件服务器确实找到机会再次发送时，Internet的黑名单积累服务很可能就已经收集到了那个发送垃圾邮件的地址，因此，灰名单积累常常和黑名单积累一起使用

许多对抗垃圾邮件的工具，依赖于对消息内容的分析，有些术语和短语更是经常地出现在垃圾邮件报头和消息中，一些垃圾邮件过滤器根据规则封存消息，例如，某一过滤器可能会封存咒骂语，或者是其他与免费解剖描述相关的术语，更加完善的方法（比如Bayesian垃圾邮件过滤技术）采用概率统计技术来分析消息内使用的词语，并给出一个得分，表明该消息为垃圾邮件的可能性，一些垃圾邮件消息怪异的词语选择和含义模糊的语言，反映出垃圾邮件制造者希望能够溜过这些针对内容概率的过滤器网络的愿望

## 21.9 小结

本章描述了在电子邮件离开你的计算机之后所发生的事情，你看到了电子邮件交付过程幕后的细节，还学习了有关SMTP以及POP3，IMAP4和webmail之类邮件检索技术的只是，本章还讨论了电子邮件客户端应用程序的角色，并且描述了正在进行的控制和遏制垃圾邮件消息的努力

## 21.10 问与答

问：问可以发送消息，但是无法连接到邮件服务器下载新的消息，我应该检查什么？

**答：** 你的电子邮件客户端应用程序使用SMTP发送消息，和一种邮件检索协议（可能是POP或者IMAP）来检查服务器上的发来消息，可能你的邮件检索协议的传输有问题，许多网络为发来的消息和外发的消息使用不同的服务器，你的POP或者IMAP服务器可能宕机了，查看你的电子邮件客户端应用程序中的配置对话框，哪里有你的POP或者IMAP服务器的名称，尝试ping一下该服务器，看它是否响应

问：一家土耳其的会计师事务所从我公司订购了14台计算机，他们坚持要求那些计算机所包括的电子邮件应用程序必须吃吃MIME，为什么他们如此固执？

**答：** 电子邮件最初被设计支持ASCII字符集，那是为使用英语书写的用户而开发的一个字符集，其他语言中使用的许多字符都不在ASCII字符集中，MIME扩展了该字符集，使其包括其他非ASCII字符

## 21.11 测验

### 21.11.1 问题

1. 什么是MIME，以及它的用途是什么？

   **答：** 一种扩展Internet邮件性能的电子邮件格式

2. 什么协议用来发送电子邮件消息

   **答：** STMP（简单邮件传输协议）用来发送消息

3. 什么协议用来从用户的邮箱中检索电子邮件消息

   **答：** POP3（邮局协议）或者IMAP（internet消息访问协议）用来从用户的邮箱中检索电子邮件消息

4. 用户对webmail最大的抱怨是什么？

   **答：** Internet的瓶颈带来的性能问题

5. webmail的优点是什么？

   **答：** 易于管理和使用，只要用户接入Internet就可以访问查看邮件

## 21.11.2 练习

略

## 21.12 关键术语

复习下列关键术语：

黑名单：一个不允许向当前域转发邮件消息的服务器列表

电子邮件主体：电子邮件消息中包含消息文本的部分

电子邮件客户端：一种客户端电子邮件应用程序，负责发送邮件，检索邮件和管理用户用来与邮件系统交互的界面

电子邮件报头：电子邮件消息的开头部分，由信息字段和相关的值组成

灰名单：通过拒绝首次递送和等着查看相应的服务器是否再次发送同一消息来探测垃圾邮件服务器的系统

Internet消息访问协议（IMAP）：一种增强型邮件检索协议，提供POP所没有的几种特性，例如，你不必首先从服务器上下载邮件消息，即可访问那些消息

邮箱：电子邮件服务器上的一个位置，为用户存储发来的消息

多用途Internet邮件扩展（MIME）：一种扩展Internet邮件性能的电子邮件格式

邮局协议（POP）：一种在Internet上使用的流行的邮件检索协议，POP使得用户能够登录到电子邮件服务器上，并下载或删除等待中的消息

简单邮件传输协议（SMTP）：一种用来在TCP/IP网络上发送邮件的协议

webmail：一种允许用户通过普通的Web浏览器访问电子邮件消息的系统

白名单：允许向所在域转发邮件消息的一个地址列表

