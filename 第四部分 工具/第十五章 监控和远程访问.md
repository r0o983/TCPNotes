# 第十五章 监控和远程访问

## 15.1 Telnet

一个Telnet会话需要一个Telnet客户端作为远程终端，以及一台Telnet服务器用于接收连接请求并允许连接

**Telnet客户端和服务器** 

![image-20200513211412562](https://raw.githubusercontent.com/christopher-x/images/main/image-20200513211412562.png)

**Telnet的网络输入和输出** 

![image-20200513211527889](https://raw.githubusercontent.com/christopher-x/images/main/image-20200513211527889.png)

在类uinx系统中的命令提示符重，Telnet命令如下方式使用：

telnet 主机名（或者IP地址）

telnet还提供一些特殊命令，在Telnet会话期间使用，命令如下所示：

* close：此命令用于关闭当前连接
* display：此命令用于显示连接设置，例如端口或者终端仿真
* evciron：此命令用于设置环境变量，环境变量被操作系统用来提供特定的用户或计算机信息

![image-20200513214040371](https://raw.githubusercontent.com/christopher-x/images/main/image-20200513214040371.png)

## 15.2 Berkeley远程工具

Berkeley远程工具（包括但不限于）：

Rlogin：允许用户远程登陆

Rcp：用于远程文件传输

Rsh：通过rshd后台程序执行一条远程命令

Rexec：通过rexecd后台程序执行一条远程命令

Ruptime：显示有关正常运行时间和连接用户数量的信息

Rwho：显示当前连接用户的信息

**UNIX的受信访问** 

![image-20200513224323982](https://raw.githubusercontent.com/christopher-x/images/main/image-20200513224323982.png)

由于/etc/hosts.equiv文件和.rhosts文件允许访问系统资源，所以它们是网络入侵者的主要搜寻目标，这些文件的脆弱性也是Berkeley远程工具被认为是不再安全的原因之一

### 15.2.1 rlogin

rlogin是一种远程登陆工具，你可以使用rlogin登陆某台正在运行服务器后台程序的unix主机，rlogin提供了与telnet相同的用途，但是rlogin的通用性要差很多，rlogin只用于提供对unix系统的访问，而telnet已经被TCP/IP协议标准覆盖，可以有更广泛的应用，rlogin也没有提供Telnet所具有的一些配置协商特性

**注意：rlogin的一个显著特点就是无需密码的远程登陆** 

**注意：** 另一种访问

需要记住的是，在用户通过某种形式的首次验证之后，许多网络操作系统同样支持对网络资源的无密码访问

rlogin命令的语法如下所示：rlogin hostname，这里的hostname表示你希望获得访问权限的计算机的主机名，如果没有指定用户名，则默认为本机上当前用户的用户名，也可以用下列命令指定一个用户名：

rlogin hostname -l username，这个username就是你想要用来登陆的用户名，接着，服务器后台程序rlogind会检查host.equiv和.rhosts文件，来验证主机和用户信息，如果验证成功，则会开启远程会话

### 15.2.2 rcp

rcp工具提供远程文件访问功能，虽然没有ftp的用途广，功能多，但有时它仍然被用来传输文件

### 15.2.3 rsh

rsh工具允许用户在不需要登陆远程计算机的情况下，就能在远程计算机上执行单条命了，rsh是远程外壳（remote shell）的缩写（外壳是操作系统的一种命令接口），运行于远程计算机上的rshd后台程序，接收rsh命令，验证用户名和主机名信息，并执行该命令，当用户不愿或不需要与远程计算机建立远程会话时，可以使用rsh工具执行输入命令，rsh命令格式如下：rsh -l username hostname command 这里的hostname表示远程计算机的主机名，username表示访问远程计算机时使用的用户名，command表示需要执行的命令

注：位于’-l‘之后的username是可选的，如果不指定某个用户名，它将默认使用本地主机上的用户名。如下所示：rsh hostname command

### 15.2.4 rexec

与rsh类似，rexec也提供在远程计算机执行命令的功能，rexex使用的是rexecd后台程序，语法如下：

rexwc hostname -l username command，hostname表示主机名，username表示远程计算机上的账户名称，command表示要执行的命令，如果省略-l username参数，用户名将默认为本地计算机上的用户名

### 15.2.5 ruptime

（这个命令我试了好久，发现没啥用。。。

ruptim饿显示网络上每台计算机的登陆用户数量，同时列出每台计算机的上线时间（因此有r-up-time这个名称）以及其他一些系统信息，要想生存一份ruptime报告，只需输入如下命令：ruptime 。ruptime和rwho都使用rwhod后台程序，实际上，每台位于网络上的计算机都有一个rwhod后台程序都接收和存储来自其他rwhod后台程序的报告，从而可以掌握整个网络的用户活动

### 15.2.6 rwho

rwho用于显示当前登陆到网络计算机上所有的用户，可以列出用户名，每个用户所登陆的计算机，登陆时间以及已登陆时间，rwho命令的语法如下：rwho  默认的报告不包含终端出于不活动状态的时间在1小时以上的用户，若要显示包含所有用户信息的报告，请使用 -a 选项：rwho -a 和ruptime一样，rwho也使用rwhod后台程序

## 15.3 安全外壳（SSH）

SSH相当于只带有公开密钥加密的Berkeley远程工具，SSH套件的主要组成部分如下所示：

* SSH：用于替代rlogin、rsh和Telnet的远程外壳程序
* scp：用于替代rcp的文件传输工具
* sftp：用于替代ftp的文件传输工具

命令格式如下：ssh username@hostname 例如：ssh pi@192.168.0.1

## 15.4 远程控制

大量的远程访问协议和工具可以让用户通过带有键盘和鼠标的普通图形桌面操作，来控制远程系统，通过图形用户界面提供远程访问似乎更复杂一些，但原理是相同的，计算机A的应用层上运行的某个软件组件截取键盘输入，并通过TCP/IP协议栈将其重定向至计算机B，计算机B的屏幕输出数据再被通过网络发送回计算机A，结果是计算机A的鼠标和键盘作为计算机B的鼠标和键盘，而计算机A的屏幕显示计算机B的桌面视图，简而言之，位于计算机A的用户通过远程控制，查看和操作计算机B

**基于GUI的远程访问工具对键盘和鼠标命令进行重定向** 

![image-20200514085839724](https://raw.githubusercontent.com/christopher-x/images/main/image-20200514085839724.png)

## 15.5 网络管理

略

## 15.6 简单网络管理协议

协议的目的是促进通信，而且只要存在某种具有与众不同且可定义特征的通信，就很可能找到相应的一种协议，简单网络管理协议（SNMP）是一种用于管理和监控网络上远程设备的协议，SNMP可以使网络具备某种能力，使得网络管理员通过一台工作站完成对计算机、路由器和其他网络设备的远程管理和监视

**一个SNMP社区包含多个一个或多个网络监视器和一个节点集** 

* 网络监视器： 一个管理控制台，有时被称为管理器或网络管理控制台（Network Management Console，NMS）它为管理网络上的设备提供了一个中央位置，网络监视器通常是一台带有必要SNMP管理软件的普通计算机
* 节点：网络上的设备
* 社区：同一个管理框架下的一组节点

一种协议提供一种通信计划，但实际的交互式发生在运行于网络设备上的应用程序之间，以SNMP为例，被称为代理的程序运行于远程节点，它与运行于网络监视器上的管理软件进行通信

**远程节点上运行的代理程序向网络监视器发送所在节点的信息，并接收更改配置设置的请求** 

![image-20200514215908626](https://raw.githubusercontent.com/christopher-x/images/main/image-20200514215908626.png)

监视器和代理使用SNMP协议进行通信，SNMP使用UDP的161端口和162端口，SNMP的早期版本不要求任何形式的用户登陆安全措施，其安全性由被称为社区字符串的社区名称提供，只有知道社区字符串才能连接，在某些情况下，也可以配置代理，使其职能从指定的IP地址接收数据，但是从现代标准考虑，这类安全措施很薄弱，SNMP的最新版本（SNMP v3）解决了这些问题，它为系统提供验证，隐私和更好的整体安全措施

### 15.6.1 SNMP地址空间

监视器和代理软件能够交换MIB中可寻址的特定位置信息，其前提是运行SNMP进程，MIB使得监视器和代理软件能够准确明白的交换信息，监视器和代理必须使用相同的MIB结构，因为它们必须要能识别出信息的每一个单元

MIN是一种分级的地址空间，包括每个信息段的唯一地址，需要注意的是，MIB地址与网络地址不同，因为MIB地址并不代表一个位置或者一台式机设备，参数集合分级排列于一个地址空间就构成了MIB，这种分级排列保证了所有SNMP设备都可用相同的相识引用特定的设置，这种做法同样利于进行权力下放，例如，某特定供应商能够定义MIB设置（通常简称为MIB）并用于该供应商的产品中，或是使某个标准组织能够管理MIB树的一部分，使其专门对应其标准，MIB使用虚线符号表示每个唯一的MIB对象地址

**MIB的部分结构图** 

![image-20200514220812687](https://raw.githubusercontent.com/christopher-x/images/main/image-20200514220812687.png)

**注意：** MIB

多个RFC中均已描述过MIB，包括RFC1158额RFC1213.在RFC1157中，可以找到SNMP的官方描述，SNMP的最新版本（SNMP v3）在RFC 2570和其他一些RFC中有描述

MIB中大多数可寻址位置都引用计数器（计数器显然是某种数字）上图中的IPForwarding（就是一个计数器）图中没有显示出来的IPInReceives也是一个计数器，每次网络软件启动或计数器重置，IPinReceives就会开始技术接收接收到的入站IP数据报量

MIB信息可以是下列任意的形式：数字、文本和IP地址等，MIB配置信息的另一个实例是IPDefaultTTL，IPDefaultTTL设置TT了参数（该参数插入到该计算机上产生的所有IP数据报中）

在MIB结构中，寻址永远起始于根部，并逐级向上定位，直到找到需要的设置，例如，要定位IPDefaultTTL和IPInReceives MIB，SNMP监视器会向SNMP代理发送下面的MIB地址：.iso.org.dod.internet.mgmt.mib.ip.ipDefaultTTL	.iso.org.dod.internet.mgmt.mib.ipInReceives，MIB树的每个位置也拥有其数字地址，可以通过其字母数字字符串或其数字地址来引用一个MIB，在网络监视器从代理软件接收到查询信息后，实际中会使用下列数字表示MIB地址：.1.3.6.1.2.1.4.2	.1.3.6.1.2.1.4.3 MIB地址使用同意的命名方式，确保监视器和代理能够可靠的引用特定的参数，这些MIB参数包含在命令中

### 15.6.2 SNMP命令

网络监视器代理软件响应3类命令：get、getnext和set，这些命令执行如下功能：

* get：get命令指示代理软件读出并返回指定的MIB信息单元
* getnext：getnext命令指示代理软件读出并返回下一个MIB信息单元，例如，可使用该命令读出一个数据表的内容
* set：set命令指示代理软件设置一个可配置的参数或重置一个对象，例如某个网络接口或某个特定的计数器

根据网络管理人员的实际需要，SNMP软件可使用多种不同方式进行工作，下面具体描述不同类型的SNMP行为

* 网络监视器代理软件一直以查询/响应方式运行，即从某台网络监视器接收请求并向其发送响应，代理软件接收get或getnext命令，然后返回来可以寻址位置的信息
* 虽然指示可选方式，代理软件经常配置为发生非正常时间时向网络监视器发送主动（unsolicited）消息，这些消息被称为“陷阱消息”或者“陷阱”，当代理软件捕获到某些不正常情况时就会产生这些消息
* 例如，SNMP代理软件通常的运行模式是监视预先定义的阀值是否被被超出，这些阀值是由set命令建立的，当阀值被超出时，代理软件会捕获到这个事件，然后生成并向网络监视器发送一条主动消息，用于捕获现场的IP地址，同时也通报被超出的是哪个阀值
* 代理软件也可以通过从监视器接收请求来执行某些动作，例如重置路由器上的特定端口，或者配置阀值等级，这些阀值是用于捕获事件的，同样，set命令用于设置可配置的参数或重置计数器或接口

下列的实例说明使用SNMP的查询和响应命令，该实例使用了名为snmputil的诊断工具，这种工具允许进行模拟监控，通过这个工具，操作员可以给代理软件发送命令，在本例中，代理软件运行于IP地址为：192.59.66.200的计算机上，并且是名为public的社区成员，注意，位于前面两个命令末尾的是.0，当读取简单变量时（例如计数器）会使用这种后缀

D:\>snmputil get 192.59.66.200 public .1.3.6.1.2.1.4.2.0  
Variable = ip.ipDefaultTTL.0  
Value = INTEGER – 128  
D:\>snmputil getnext 192.59.66.200 public .1.3.6.1.2.1.4.2.0  
Variable = ip.ipInReceives.0  
Value = Counter – 11898   

**注意：** 更改名称

许多SNMP系统上的默认社区名称都是public在这个示例中，管理员应该把该名称改为其他名称，如果使用默认名称，就会给攻击者一个良好的开端

SNMP对网络管理员来说非常有用，但是其他它并不完美，下面列出一些SNMP的缺点

* 无法查看网络低层：SNMP位于UDP上面的应用层中，所以无法查看协议栈最底层发生的事件，例如网络访问层上发生的事件
* 需要一个可运行的协议栈：SNMP监视器和代理软件进行通信，需要一个完全可运行的TCP/IP栈，如果出现了使得该协议栈无法正确工作的网络问题，那么SNMP就无能为力了
* 会产生很大的网络流量：SNMP使用的查询响应机制造成大量的网络流量，尽管在重要事件发生时会发送主动陷阱消息，但实际上，当网络监视器向代理软件查询特定信息时，会产生恒定大小的网络流量
* 提供的数据量过多而有用的信息过少：MIB包含着数以千计的地址位置，可以检索到许多小片的信息，但是，只有通过强大管理控制台来分析这些微小的细节，才能成功的分析出特定设备中发生的故障
* 只提供设备视图而没有提供网络视图：使用SNMP只能得到特定设备的信息，而不能使我们直接了解网段的事件情况

## 15.7 远程监控

远程监控（RMON）是MIB地址空间的扩展，可以用于远程局域网的监控和维护，SNMP提供单台计算机的信息检索，与之不同的是，RMON直接从网络戒指捕获数据，因此，可以获得局域网的整体信息

RMON MIB始于地址.1.3.6.1.2.1.16，目前分为20组，例如，从.1.3.6.1.2.16.1~.1.3.6.1.2.1.16.20，RMON由IETF开发，用于解决SNMP的缺陷，并使远程局域网的流量更为清晰

RMON有两个版本：RMON1和RMON2

* RMON1:RMON1用于监控以太局域网，RMON1中包含所有组都用于监控网络的最低两层，例如OSI参考模型中的物理层和数据链路层（在TCP/IP协议模型中，对应的是网络访问层）
* RMON2：RMON2提供了RMON1的功能，并且允许对OSI参考模型的其余5层（在TCP/IP协议模型中，对应的是网际层，传出层和应用层）进行监控

由于RMON2是对TCP/IP协议栈的更高层进行监听，因此可以提供更高级别协议的信息，比如IP、TCP、和NFS协议等

RMON用于捕获网络流量数据，RMON代理软件（或称为探测软件）在网段上进行监听，并将流量数据转发到RMON数据台，如果网络包含多个网段，则需要运行不同的代理软件针对每一个网段进行监听，RMON信息被收集到一组统计数据中，这组统计数据关联着不同种类的信息，RMON1有以下10种类型的组

* 以太网统计：统计组拥有从每个探测网段搜集到的表格形式的统计信息，这个组中的一些计数器用于追踪数据包、广播、冲突、过小数据和过大数据报等的数量
* 以太网历史：历史组拥有定期编译的统计信息，并将这个信息储存起来备以后查看，四分之三历史控制：历史控制组包含管理数据采样的控制信息
* 警告：警告组需要同其他事件组结合工作，警告组定期检测探测软件内变量的统计样本，并将其与已经配置的阀值进行对比，当阀值被超出时，就会产生相应的事件通知网络管理者
* 主机：主机组维护网段上的每台主机的统计信息，它是通过检测数据报中的源目的和物理地址来获取这些信息
* 主机排行：在某一个特定分类中，主机按照已定义的数值进行排列，主机排列组根据这些主机的统计信息来生成报告，例如，某网络管理员可能要查找哪台主机都在大多数数据报中出现过，或者哪台主机发送了大多的过大或过小的数据报
* 矩阵：矩阵组构建了一个表，该表包含网络上监控到的每个数据报的源和目的物理地址对信息，这些地址对用于定义两地址之间的会话
* 过滤：过滤组利用生成的二进制模式匹配或过滤网络中的数据报
* 数据包捕获：捕获组捕获过滤组选取的数据报，以供日后被网络管理员检索和分析
* 事件：事件组与警告组一同工作，当某个监控对象的阀值被超出时，它会生成事件以通知网络管理员

由于需要监视上层协议，RMON2还提供了其他组

## 15.8 小结

本章介绍了一些TCP/IP远程访问工具，它们伴随TCP/IP协议不断进化着，你学习了Telnet、Berkeley远程工具和SSH，可以使用这些工具在远程计算机上执行和获取信息

你还学习了集中监控和远程网络维护不可缺少的SNMP协议，通过使用网络管理服务台和中心站点，网络管理员可以获知异常情况的发生，并通过路由器、HUB和服务器上运行的代理所产生的报告，来查看网络流量状态，网络管理控制台还允许网络管理员完成像重置路预期端口这样的功能，甚至在一般措施无法排除故障的情况下重置远程设备

目前，许多比较新的网络设备都包含了嵌入式的远程监控（RMON）特性，RMON能够大大减少与SNMP相关的网络流量，而且不需要强大的网络控制台来截获数据，但是，在使用RMON时，为了捕获网络流量，RMON代理或探测软件会进行大量的处理工作

## 15.9 问与答

问：Telnet服务器应用程序，客户端应用程序还是一个协议？

**答：** 术语Telnet可以指服务器应用程序，也可以指客户端应用程序，或者是协议

问：如果指定一台主机为受信主机，需要使用哪个文件？

**答：** 使用某个用户目录下的/etc/hosts.equiv文件或者rhosts文件来指定受信主机

问：使用哪个工具能判断用户Ethelred目前是否登陆到网络上？

**答：** rwho工具显示有关当前用户的信息

问：SNMP协议使用哪种传输协议和端口？

**答：** SNMP通常使用UDP的161端口，162端口用于SNMP陷阱

问：事件发生时，代理程序以主动模式发送的消息名称是什么？

**答：** 陷阱消息

问：RMON1位于TCP/IP模型的哪一层？

**答：** 网络访问层

问：RMON2位于TCP/IP模型的哪一层？

**答：** RMON2覆盖了TCP/IP协议栈的所有层

问：若要监视网络流量等级的周期性变化，应使用SNMP还是RMON？

**答：** SNMP主要用于监视网络设备，RMON直接从网络截至捕获数据，所以更适于监视网络流量

## 15.10 测验

### 15.10.1 问题

1. 与Telnet相比，人们为什么更喜欢SSH？

   **答：** SSH相比Telnet更安全

2. 哪一组工具具有“受信访问“的概念？

   **答：** Berkeley的r*工具使用的受信访问的概念

3. 哪一个协议使用MIB来组织它的数据？

   **答：** SNMP协议

4. 为什么SNMP提供的是受限的视图？

   **答：** SNMP只能得到特定的设备信息，而不是使我们直接了解网段的事件情况

5. RMON2为RMON1添加了什么功能？

   **答：** RMON2可以监控RMON1监控不到的其他5层协议信息

### 15.10.2 练习

略

## 15.11 关键术语

复习下列关键术语：

* 大力：家在到某台主机上的SNMP软件，它能够读取MIB并以期望的结果响应监视器，代理能够在重要异常事件发生时向监视器传送主动消息
* 社区字符串：与一个SNMP网络或监控组相关的名称
* 管理信息库（MIB）：SNMP监视器和代理使用的一种分层地址空间，通过使用虚线符号，以从MIB结构的根部向下搜索MIB地址的方式，来定位MIB中的特定参数
* 探测器：代理的别称，在设计RMON时，经常使用这个术语
* rcp：一种远程文件传输工具
* 远程监控（RMON）：一种服务和MIB扩展，能提供比传统的SNMP更强大的功能，为了在RMON MIB中存储数据，代理或探测器中必须包含RMON软件
* rexec：一种远程命令执行工具
* rlogin：一种远程登陆工具
* rsh：一种远程命令执行工具
* ruptime：一种显示正常运行时间和连接用户数量等系统信息的工具
* rwho：一种显示当前连接用户信息的工具
* 完全外壳（SSH）：一组工具，它可以提供一个安全而且加密的远程外壳访问解决方案
* Shell：操作系统的命令行接口
* 简单网络管理协议（SNMP）：一种用于管理TCP/IP网络资源的协议
* Telnet：一种一度很流行的远程终端工具，现在基本上被更为安全的SSH取代
* 陷阱：SNMP代理发送的一个主动消息，用来通知发生了某一事件
* 受信访问：一种薄弱的安全系统，系统管理员在其中制定可以访问本地系统的受信远程主机和用户